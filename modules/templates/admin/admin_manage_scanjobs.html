<!-- templates/admin/manage_scans.html -->

{% extends "base.html" %}
{% block content %}
{% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% if verify_file('./modules/static/library/themes/' + current_theme + '/css/admin/admin_manage_scanjobs.css') == True %}
	<link rel="stylesheet" href="{{ url_for('static', filename='library/themes/' + current_theme + '/css/admin/admin_manage_scanjobs.css') }}">
{% else %}
	<link rel="stylesheet" href="{{ url_for('static', filename='library/themes/default/css/admin/admin_manage_scanjobs.css') }}">
{% endif %}

<meta name="active-tab" content="{{ active_tab }}">
<meta name="selected-library-uuid" content="{{ selected_library_uuid }}">

<!-- Back to Dashboard Button -->
<div class="container">
    <div class="glass-panel">
        <a href="{{ url_for('site.admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="admin_manage_scanjobs-nav-panel mt-3">
    <div class="container-settings">
        <!-- Nav tabs -->
        <ul class="admin_manage_scanjobs-nav-tabs nav nav-tabs">
            <li class="admin_manage_scanjobs-nav-item nav-item">
                <a class="admin_manage_scanjobs-nav-link nav-link" id="autoScan-tab" data-bs-toggle="tab" href="#autoScan">Auto Scan</a>
            </li>
            <li class="admin_manage_scanjobs-nav-item nav-item">
                <a class="admin_manage_scanjobs-nav-link nav-link" id="manualScan-tab" data-bs-toggle="tab" href="#manualScan">Manual Scan</a>
            </li>
            <li class="admin_manage_scanjobs-nav-item nav-item">
                <a class="admin_manage_scanjobs-nav-link nav-link" id="unmatchedFolders-tab" data-bs-toggle="tab" href="#unmatchedFolders">Unmatched Folders</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="admin_manage_scanjobs-tab-content tab-content">
            <!-- Auto Scan Tab -->
            <div id="autoScan" class="admin_manage_scanjobs-tab-panel tab-pane active">
                <div class="auto-scan-header">
                    <h3 class="section-title">Automatic Folder Scan</h3>
                    <p class="section-subtitle">Configure and run automated scans to discover games in your library folders</p>
                </div>
                
                {% if libraries|length > 0 %}
                <form action="" method="post">
                    {{ auto_form.hidden_tag() }}
                    
                    <!-- Configuration Card -->
                    <div class="config-card">
                        <div class="card-header">
                            <h4 class="card-title"><i class="fas fa-cogs"></i> Scan Configuration</h4>
                        </div>
                        <div class="card-content">
                            <div class="config-grid">
                                <!-- Library Selection -->
                                <div class="config-item">
                                    {{ auto_form.library_uuid.label(class="config-label") }}
                                    {{ auto_form.library_uuid(class="form-control config-input", id="libraryUuid", onchange='onLibraryChange(this.value, "auto")') }}
                                    {% if auto_form.library_uuid.errors %}
                                        {% for error in auto_form.library_uuid.errors %}
                                            <div class="alert alert-danger">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>

                                <!-- Scan Mode -->
                                <div class="config-item">
                                    <label class="config-label">{{ auto_form.scan_mode.label.text }}</label>
                                    <div class="radio-group">
                                        {% for subfield in auto_form.scan_mode %}
                                            <div class="radio-option">
                                                {{ subfield(class="form-check-input") }}
                                                {{ subfield.label(class="form-check-label") }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if auto_form.scan_mode.errors %}
                                        {% for error in auto_form.scan_mode.errors %}
                                            <div class="alert alert-danger">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Options Row -->
                            <div class="options-row">
                                <div class="option-item">
                                    <div class="form-check modern-checkbox">
                                        {{ auto_form.remove_missing(class="form-check-input") }}
                                        {{ auto_form.remove_missing.label(class="form-check-label") }}
                                    </div>
                                </div>
                                
                                <div class="option-item">
                                    <div class="form-check modern-checkbox">
                                        {{ auto_form.download_missing_images(class="form-check-input") }}
                                        {{ auto_form.download_missing_images.label(class="form-check-label") }}
                                    </div>
                                </div>
                                
                                <div class="option-item">
                                    <div class="form-check modern-checkbox">
                                        {{ auto_form.force_updates_extras_scan(class="form-check-input", id="force-updates-extras-auto") }}
                                        {{ auto_form.force_updates_extras_scan.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                    <!-- Path Selection Card -->
                    <div class="path-card">
                        <div class="card-header">
                            <h4 class="card-title"><i class="fas fa-folder"></i> Scan Location</h4>
                        </div>
                        <div class="card-content">
                            <div class="path-input-group">
                                {{ auto_form.folder_path.label(class="config-label") }}
                                <div class="scan-controls-group" style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                                    <button type="submit" name="submit" value="AutoScan" class="btn btn-primary browse-btn" style="margin-right: 10px;">
                                        <i class="fas fa-play"></i> Start Scan
                                    </button>
                                    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                                        <img src="/static/newstyle/searching_small.gif" alt="Loading...">
                                    </div>
                                </div>
                                <div class="input-with-button">
                                    {{ auto_form.folder_path(class="form-control path-input") }}
                                    <button id="browseFoldersBtn" type="button" class="btn btn-info browse-btn" data-browse-url="{{ url_for('apis.browse_folders_ss') }}">
                                        <i class="fas fa-search"></i> Browse
                                    </button>
                                </div>
                                {% if auto_form.folder_path.errors %}
                                    {% for error in auto_form.folder_path.errors %}
                                        <div class="alert alert-danger">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="folder-browser">
                                <button id="upFolderBtn" type="button" class="btn btn-secondary up-btn" style="display: none;">
                                    <i class="fas fa-arrow-up"></i> Up
                                </button>
                                <div id="folderContents" class="folder-contents"></div>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="no-libraries-card">
                    <div class="no-libraries-content">
                        <i class="fas fa-book-open"></i>
                        <h4>Welcome to Scan Management</h4>
                        <p>Get started by creating your first library to organize your game collection.</p>
                        <p class="help-text">Libraries help organize your games by platform, genre, or any way you prefer.</p>
                        <a href="{{ url_for('library.libraries') }}" class="btn btn-elegant create-library-btn">
                            <i class="fas fa-plus-circle"></i> Create Your First Library
                        </a>
                    </div>
                </div>
                {% endif %}
                <!-- Scan Jobs Management Card -->
                <div class="scan-jobs-card">
                    <div class="card-header">
                        <div class="jobs-header-content">
                            <div class="jobs-title-section">
                                <h4 class="card-title">
                                    <i class="fas fa-tasks"></i> Active Scan Jobs
                                </h4>
                                <p class="jobs-subtitle">Monitor and manage running scan operations</p>
                            </div>
                            <div class="jobs-controls">
                                <form action="{{ url_for('main.clear_all_scan_jobs') }}" method="post" class="inline-form">
                                    {{ csrf_form.csrf_token }}
                                    <button type="submit" class="btn btn-outline-danger btn-sm control-btn" onclick="return confirm('Delete ALL jobs?');">
                                        <i class="fas fa-trash"></i> <span class="btn-text">Clear All</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <div class="jobs-table-wrapper">
                            <table id="scanJobsTable" class="simple-jobs-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Library</th>
                                        <th>Path</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <!-- Scan job rows will be dynamically populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Scan Tab -->
            <div id="manualScan" class="admin_manage_scanjobs-manual-panel glass-panel tab-pane fade"><br>
                <div class="admin_manage_scanjobs-tab-header">
                    <h3>Manual Folder Scan</h3>
                </div>
                <form action="" method="post">
                    {{ manual_form.hidden_tag() }}
                    <!-- Library Selection -->
                    <div class="admin_manage_scanjobs-library form-group">
                        {{ manual_form.library_uuid.label }}
                        {{ manual_form.library_uuid(class="form-control", id="manualLibraryUuid", onchange='onLibraryChange(this.value, "manual")') }}
                        {% if manual_form.library_uuid.errors %}
                            {% for error in manual_form.library_uuid.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <!-- Scan Mode -->
                    <div class="admin_manage_scanjobs-scanmode form-group">
                        {{ manual_form.scan_mode.label }}
                        {% for subfield in manual_form.scan_mode %}
                            <div class="form-check">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="form-group">
                        {{ manual_form.folder_path.label }}
                        {{ manual_form.folder_path(class="form-control", id="manualFolderPath") }}
                        {% if manual_form.folder_path.errors %}
                            {% for error in manual_form.folder_path.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Options -->
                    <div class="form-check modern-checkbox">
                        {{ manual_form.force_updates_extras_scan(class="form-check-input", id="force-updates-extras-manual") }}
                        {{ manual_form.force_updates_extras_scan.label(class="form-check-label") }}
                    </div>
                    
                    <div class="form-group">
                        <button id="browseFoldersBtnManual" type="button" class="admin_manage_scanjobs-browsefolders-btn btn btn-info">Browse Folders</button>
                        <button type="submit" name="submit" value="ManualScan" class="admin_manage_scanjobs-browsefolders-listgames-btn btn btn-primary">List Games</button>
                        <button id="upFolderBtnManual" type="button" class="admin_manage_scanjobs-browsefolders-up-btn btn btn-secondary" style="display: none;">Up</button>
                    </div>
                </form>
                <div id="loadingSpinnerManual" class="loading-spinner">
                    <img src="/static/newstyle/searching_small.gif" alt="Loading...">
                </div>
                <div id="folderContentsManual"></div>
            
                {% if game_names_with_ids %}
                <br>
                <div class="admin_manage_scanjobs-foundgames-header">
                    <h4>Found Games:</h4>
                </div>
                <div class="admin_manage_scanjobs-foudngames-list list-group">
                    {% for game in game_names_with_ids %}
                        <div class="admin_manage_scanjobs-list-item list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            {{ game['name'] }}
                            <!-- Identify Form for each game -->
                            <form action="{{ url_for('games.add_game_manual') }}" method="GET">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                <input type="hidden" name="full_disk_path" value="{{ game['full_path'] }}">
                                <input type="submit" class="admin_manage_scanjobs-identify-btn btn btn-primary btn-sm" value="Identify">
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            
                </div>

            <!-- Unmatched Folders Tab -->
            <div id="unmatchedFolders" class="admin_manage_scanjobs-unmatched-container container tab-pane fade"><br>
                <div class="admin_manage_scanjobs-unmatched-panel glass-panel">
                    <div class="admin_manage_scanjobs-tab-header">
                        <h3>Resolve Unmatched Folders</h3>
                    </div>
                    <!-- spinner -->
                    <div id="globalSpinner">
                        <img src="{{ url_for('static', filename='/newstyle/searching.gif') }}" alt="Loading...">
                    </div>

                    <div class="container-unmatched-buttons mb-3">
                        <form action="" method="post">
                            {{ csrf_form.csrf_token }}
                            <input type="hidden" name="submit" value="DeleteAllUnmatched">
                            <button type="submit" class="admin_manage_scanjobs-clearall-btn btn btn-danger"  title="Clear the entire table" onclick="return confirm('Are you sure you want to delete all entries in the list? This cannot be undone.');">Clear All</button>
                        </form>
                        <form action="" method="post">
                            {{ csrf_form.csrf_token }}
                            <input type="hidden" name="submit" value="DeleteOnlyUnmatched">
                            <button type="submit" class="admin_manage_scanjobs-clearunmatched-btn btn btn-warning" title="Remove folders with statsus Unmatched" onclick="return confirm('Are you sure you want to clear all unmatched folders? This cannot be undone.');">Clear Unmatched</button>
                        </form>
                    </div>
                    <table id="unmatchedTable" class="simple-unmatched-table table" style="border-radius: 15px;">
                        <thead>
                            <tr>
                                <th>Folder Path</th>
                                <th>Status</th>
                                <th>Library</th>
                                <th>Platform</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unmatchedFoldersTableBody">
                            <!-- This will be populated dynamically by JavaScript -->
                        </tbody>
                    </table>
                    
                </div>

            </div>
        </div>
    </div>        
</div>
{% if verify_file('./modules/static/library/themes/' + current_theme + '/js/admin_manage_scanjobs.js') %}
<script type="module" src="{{ url_for('static', filename='library/themes/' + current_theme + '/js/admin_manage_scanjobs.js') }}"></script>
{% else %}
<script type="module" src="{{ url_for('static', filename='library/themes/default/js/admin_manage_scanjobs.js') }}"></script>
{% endif %}

<script>
    function onLibraryChange(libraryUuid, scanType) {
        // Update the URL with the new library_uuid parameter and active_tab
        const url = new URL(window.location.href);
        url.searchParams.set('library_uuid', libraryUuid);
        url.searchParams.set('active_tab', scanType === 'manual' ? 'manual' : 'auto');
        window.location.href = url.toString();
    }
    </script>
        
{% endblock %}
