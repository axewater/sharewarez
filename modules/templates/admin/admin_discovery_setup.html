{% extends "base.html" %}
{% block content %}

{% if verify_file('./modules/static/library/themes/' + current_theme + '/css/admin/admin_discovery_setup.css') == True %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/' + current_theme + '/css/admin/admin_discovery_setup.css') }}">
{% else %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/default/css/admin/admin_discovery_setup.css') }}">
{% endif %}

<div class="admin-panel">
    <div class="hackplanet_titles">
        <h1>Discovery Page Setup</h1>
    </div>
    
    <div class="setup-container">
        <div class="setup-section">
            <h3>Discovery Page Configuration</h3>
            <p>Configure which sections appear on the discovery page and their order.</p>
            
            <form id="discoveryForm" class="discovery-form">
                <div id="sectionContainer" class="section-container">
                    <!-- Sections will be populated by JavaScript -->
                </div>
                <button type="submit" class="save-button">Save Changes</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDiscoverySettings();
    
    document.getElementById('discoveryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveDiscoverySettings();
    });
});

function loadDiscoverySettings() {
    fetch('/admin/api/discovery_settings')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('sectionContainer');
            Object.entries(data.sections).forEach(([key, section]) => {
                container.appendChild(createSectionElement(key, section));
            });
            initializeSortable();
        });
}

function createSectionElement(key, section) {
    const div = document.createElement('div');
    div.className = 'section-item';
    div.setAttribute('data-section-key', key);
    
    div.innerHTML = `
        <div class="drag-handle">â˜°</div>
        <input type="text" class="section-title" value="${section.title}" 
               placeholder="Section Title">
        <label class="toggle-switch">
            <input type="checkbox" ${section.enabled ? 'checked' : ''}>
            <span class="slider"></span>
        </label>
    `;
    
    return div;
}

function initializeSortable() {
    new Sortable(document.getElementById('sectionContainer'), {
        handle: '.drag-handle',
        animation: 150
    });
}

function saveDiscoverySettings() {
    const sections = {};
    document.querySelectorAll('.section-item').forEach((item, index) => {
        const key = item.getAttribute('data-section-key');
        sections[key] = {
            title: item.querySelector('.section-title').value,
            enabled: item.querySelector('input[type="checkbox"]').checked,
            order: index + 1
        };
    });
    
    fetch('/admin/api/discovery_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sections })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully!');
        }
    });
}
</script>

{% endblock %}
