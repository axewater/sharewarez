{% extends "base.html" %}
{% block content %}

<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Load individual CSS files for each integration -->
<link rel="stylesheet" href="{{ 'css/admin/admin_manage_smtp_settings.css'|theme_asset }}">
<link rel="stylesheet" href="{{ 'css/admin/admin_manage_igdb_settings.css'|theme_asset }}">
<link rel="stylesheet" href="{{ 'css/admin/admin_manage_discord_settings.css'|theme_asset }}">
<link rel="stylesheet" href="{{ 'css/admin/integrations_tabs.css'|theme_asset }}">

<div class="container">
    <div class="glass-panel">
        <a href="{{ url_for('site.admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="container-settings mt-4">
    <div class="card">
        <h2><i class="fas fa-plug"></i> Integrations Management</h2>
        <p>Manage all your external service integrations in one place.</p>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Nav tabs -->
        <ul class="integrations-nav-tabs nav nav-tabs" id="integrationTabs" role="tablist">
            <li class="integrations-nav-item nav-item" role="presentation">
                <button class="integrations-nav-link nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false">
                    <i class="fas fa-envelope"></i> Email Settings
                </button>
            </li>
            <li class="integrations-nav-item nav-item" role="presentation">
                <button class="integrations-nav-link nav-link" id="igdb-tab" data-bs-toggle="tab" data-bs-target="#igdb" type="button" role="tab" aria-controls="igdb" aria-selected="false">
                    <i class="fas fa-gamepad"></i> IGDB Settings
                </button>
            </li>
            <li class="integrations-nav-item nav-item" role="presentation">
                <button class="integrations-nav-link nav-link" id="discord-tab" data-bs-toggle="tab" data-bs-target="#discord" type="button" role="tab" aria-controls="discord" aria-selected="false">
                    <i class="fab fa-discord"></i> Discord Settings
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="integrations-tab-content tab-content" id="integrationTabContent">

            <!-- Email Settings Tab -->
            <div class="integrations-tab-pane tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                <div class="tab-content-wrapper">
                    <h4><i class="fas fa-envelope"></i> SMTP Email Settings <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#smtpHelpModal">
                        <i class="fas fa-question-circle"></i>
                    </button></h4>

                    {% include 'partials/integrations/smtp_form.html' %}
                </div>
            </div>

            <!-- IGDB Settings Tab -->
            <div class="integrations-tab-pane tab-pane fade" id="igdb" role="tabpanel" aria-labelledby="igdb-tab">
                <div class="tab-content-wrapper">
                    <h4><i class="fas fa-gamepad"></i> IGDB API Settings</h4>

                    {% include 'partials/integrations/igdb_form.html' %}
                </div>
            </div>

            <!-- Discord Settings Tab -->
            <div class="integrations-tab-pane tab-pane fade" id="discord" role="tabpanel" aria-labelledby="discord-tab">
                <div class="tab-content-wrapper">
                    <div class="discord-settings-container">
                        <!-- Connection Settings Section -->
                        <div class="connection-settings-section">
                            <h4><i class="fab fa-discord"></i> Discord Connection Settings <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#discordHelpModal">
                                <i class="fas fa-question-circle"></i>
                            </button></h4>
                            <p class="text-muted">Configure your Discord webhook and bot settings</p>

                            <div class="connection-card">
                                {% include 'partials/integrations/discord_form.html' %}
                            </div>
                        </div>

                        <!-- Notification Settings Section -->
                        {% include 'partials/integrations/discord_notifications.html' %}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Embed current settings as JSON for JavaScript -->
<script id="currentSettings" type="application/json">{{ current_settings|tojson }}</script>

<!-- Load individual JavaScript files for each integration -->
<script src="{{ 'js/admin_manage_smtp_settings.js'|theme_asset }}"></script>
<script src="{{ 'js/password_visibility.js'|theme_asset }}"></script>
<script src="{{ 'js/admin_manage_igdb_settings.js'|theme_asset }}"></script>
<script src="{{ 'js/admin_manage_discord_settings.js'|theme_asset }}"></script>
<script src="{{ 'js/discord_notifications.js'|theme_asset }}"></script>
<script src="{{ 'js/integrations_tabs.js'|theme_asset }}"></script>

<script>
// Auto-activate Discord tab if there are Discord-related messages
document.addEventListener('DOMContentLoaded', function() {
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                {% if 'Discord' in message %}
                    // Activate Discord tab if there's a Discord-related flash message
                    const discordTab = document.getElementById('discord-tab');
                    const discordPane = document.getElementById('discord');
                    if (discordTab && discordPane) {
                        // Remove active class from all tabs and panes
                        document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(pane => {
                            pane.classList.remove('show', 'active');
                        });

                        // Activate Discord tab
                        discordTab.classList.add('active');
                        discordPane.classList.add('show', 'active');
                    }
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}
});
</script>

{% endblock %}