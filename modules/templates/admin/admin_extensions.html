{% extends "base.html" %}
{% block content %}

{% if verify_file('./modules/static/library/themes/' + current_theme + '/css/admin/admin_extensions.css') == True %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/' + current_theme + '/css/admin/admin_extensions.css') }}">
{% else %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/default/css/admin/admin_extensions.css') }}">
{% endif %}

<div class="alert alert-info" role="alert">
    <h4 class="alert-heading">File Extensions</h4>
    <p>The extensions listed below are used to identify game files during the scanning process. Only files with these extensions will be recognized as games when scanning folders. This helps ensure that only valid game files are added to your library.</p>
    <hr>
    <p class="mb-0">Add or remove extensions as needed to match the types of game files in your collection.</p>
</div>

{% with messages = get_flashed_messages() %}
{% if messages %}
    <div class="alert alert-info" role="alert">
        {% for message in messages %}
            {{ message }}<br>
        {% endfor %}
    </div>
{% endif %}
{% endwith %}

<div class="glass-panel">
    <div class="container mt-3">
        <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-lg btn-primary">Back to Dashboard</a>
    </div>
    
    <div class="content-panel">
        <div class="row">
            <!-- Allowed File Types -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Allowed File Types</h3>
                        <button class="btn btn-primary btn-sm" onclick="addFileType('allowed')">
                            <i class="fas fa-plus"></i> Add New
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover" id="allowedTypesTable">
                            <thead>
                                <tr>
                                    <th>Extension</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for type in allowed_types %}
                                <tr data-id="{{ type.id }}" data-category="allowed">
                                    <td class="type-value">{{ type.value }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editFileType(this)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteFileType('allowed', {{ type.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="fileTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit File Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalTypeCategory">
                <input type="hidden" id="modalTypeId">
                <div class="form-group">
                    <label for="fileTypeValue">File Extension:</label>
                    <input type="text" class="form-control" id="fileTypeValue" maxlength="10">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFileType()">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
let modal;

document.addEventListener('DOMContentLoaded', function() {
    modal = new bootstrap.Modal(document.getElementById('fileTypeModal'));
});

function addFileType(category) {
    document.getElementById('modalTypeCategory').value = category;
    document.getElementById('modalTypeId').value = '';
    document.getElementById('fileTypeValue').value = '';
    document.querySelector('.modal-title').textContent = 'Add New File Type';
    modal.show();
}

function editFileType(category, id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const value = row.querySelector('.type-value').textContent;
    
    document.getElementById('modalTypeCategory').value = category;
    document.getElementById('modalTypeId').value = id;
    document.getElementById('fileTypeValue').value = value;
    document.querySelector('.modal-title').textContent = 'Edit File Type';
    modal.show();
}

function saveFileType() {
    const category = document.getElementById('modalTypeCategory').value;
    const id = document.getElementById('modalTypeId').value;
    const value = document.getElementById('fileTypeValue').value;

    if (!value) {
        alert('Please enter a file extension');
        return;
    }

    const method = id ? 'PUT' : 'POST';
    const data = id ? { id, value } : { value };

    fetch(`/api/file_types/${category}`, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        // Instead of reloading, update the table maintaining sort order
        updateTableWithNewData(category, data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving');
    });
}

function deleteFileType(category, id) {
    if (!confirm('Are you sure you want to delete this file type?')) {
        return;
    }

    fetch(`/api/file_types/${category}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting');
    });
}
</script>

    </div>
</div>

{% endblock %}
