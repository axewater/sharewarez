{% extends "base.html" %}
{% block content %}

{% if verify_file('./modules/static/library/themes/' + current_theme + '/css/admin/admin_igdb_settings.css') == True %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/' + current_theme + '/css/admin/admin_igdb_settings.css') }}">
{% else %}
    <link rel="stylesheet" href="{{ url_for('static', filename='library/themes/default/css/admin/admin_igdb_settings.css') }}">
{% endif %}

<div class="igdb-settings-container">
    <div class="glass-panel">
        <h2>IGDB API Settings</h2>

        <div class="instructions-toggle">
            <button class="btn btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#instructionsPanel" aria-expanded="false" aria-controls="instructionsPanel">
                <i class="fas fa-chevron-down" id="toggleIcon"></i> Show Instructions
            </button>
        </div>

        <div class="collapse instructions-panel" id="instructionsPanel">
            <h3>How to Get Your IGDB API Credentials</h3>
            <ol>
                <li>Go to the <a href="https://dev.twitch.tv/console" target="_blank">Twitch Developer Console</a></li>
                <li>Log in with your Twitch account (or create one if needed)</li>
                <li>Click on "Register Your Application"</li>
                <li>Fill in the application details:
                    <ul>
                        <li>Name: Your choice (e.g., "MySharewareZ")</li>
                        <li>OAuth Redirect URL: http://localhost (if testing locally)</li>
                        <li>Category: Select "Website Integration"</li>
                    </ul>
                </li>
                <li>After registering, you'll receive your Client ID</li>
                <li>Click "New Secret" to generate your Client Secret</li>
            </ol>
            <div class="note">
                <strong>Note:</strong> IGDB is owned by Twitch, which is why credentials are obtained through the Twitch Developer Console.
                The free tier includes 4 requests per second and 500k requests per month.
            </div>
        </div>
        
        <div class="settings-form">
            <div class="form-group">
                <label for="igdb_client_id">Client ID</label>
                <input type="text" id="igdb_client_id" value="{{ settings.igdb_client_id if settings else '' }}" class="form-control" 
                    minlength="20" maxlength="50">
            </div>
            
            <div class="form-group">
                <label for="igdb_client_secret">Client Secret</label>
                <input type="password" id="igdb_client_secret" value="{{ settings.igdb_client_secret if settings else '' }}" class="form-control"
                    minlength="20" maxlength="50">
            </div>
            
            {% if settings and settings.igdb_last_tested %}
            <div class="last-tested">
                Last tested: {{ settings.igdb_last_tested.strftime('%Y-%m-%d %H:%M:%S') }}
            </div>
            {% endif %}
            
            <div class="button-group">
                <button onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
                <button onclick="testSettings()" class="btn btn-secondary">Test Connection</button>
            </div>
        </div>
    </div>
</div>

<script>
function saveSettings() {
    const clientId = document.getElementById('igdb_client_id').value;
    const clientSecret = document.getElementById('igdb_client_secret').value;

    // Basic validation
    if (clientId.length < 20 || clientSecret.length < 20) {
        $.notify("Client ID and Secret must be at least 20 characters long", "error");
        return;
    }

    const data = {
        igdb_client_id: clientId,
        igdb_client_secret: clientSecret
    };

    fetch('/admin/igdb_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            $.notify("IGDB settings saved successfully", "success");
        } else {
            $.notify("Error saving IGDB settings: " + data.message, "error");
        }
    })
    .catch(error => {
        $.notify("Error saving IGDB settings: " + error, "error");
    });
}

function testSettings() {
    const testButton = document.querySelector('button.btn-secondary');
    const originalText = testButton.textContent;
    testButton.disabled = true;
    testButton.textContent = 'Testing...';
    
    fetch('/admin/test_igdb', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            $.notify("IGDB API test successful", "success");
            setTimeout(() => location.reload(), 2000);
        } else {
            $.notify("IGDB API test failed: " + data.message, "error");
        }
    })
    .catch(error => {
        $.notify("Error testing IGDB API: " + error, "error");
    })
    .finally(() => {
        testButton.disabled = false;
        testButton.textContent = originalText;
    });
}
</script>

{% endblock %}
