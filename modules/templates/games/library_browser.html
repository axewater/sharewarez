<!-- in templates/games/library_browser.html -->
{% extends "base.html" %}

{% block content %}

<link rel="stylesheet" href="{{ 'css/games/library_browser.css'|theme_asset }}">
<link rel="stylesheet" href="{{ 'css/games/game_status.css'|theme_asset }}">

<head>
    <meta charset="UTF-8">
    <title>Browse Games</title>
    <script src="{{ 'js/popup_menu.js'|theme_asset }}"></script>
    <script src="{{ 'js/library_slideshow.js'|theme_asset }}"></script>
    <script src="{{ 'js/library_pagination.js'|theme_asset }}"></script>
    <script src="{{ 'js/library_search.js'|theme_asset }}"></script>
    <script src="{{ 'js/favorites_manager.js'|theme_asset }}"></script>
    <script src="{{ 'js/game_status_manager.js'|theme_asset }}"></script>
</head>
<body data-user-per-page="{{ user_per_page }}" data-user-default-sort="{{ user_default_sort }}" data-user-default-sort-order="{{ user_default_sort_order }}" data-enable-delete-game-on-disk="{{ enable_delete_game_on_disk|lower }}" data-discord-configured="{{ discord_configured|lower }}" data-discord-manual-trigger="{{ discord_manual_trigger_enabled|lower }}" data-is-admin="{{ is_admin|lower }}" data-show-play-status="{{ show_play_status|lower }}" data-current-filters="{{ filters|tojson|e }}" data-current-page="{{ current_page }}" data-total-pages="{{ pages }}">


    <div class="glass-panel">
        <!-- Top Pagination Bar -->
        <div class="pagination-header">
            <div class="pagination-controls-left">
                <span class="pagination-label">Items per page:</span>
                <select id="perPageSelect" class="dropdown-perpage">
                    <option value="16" {% if user_per_page == 16 %}selected{% endif %}>16</option>
                    <option value="20" {% if user_per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if user_per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if user_per_page == 100 %}selected{% endif %}>100</option>
                    <option value="500" {% if user_per_page == 500 %}selected{% endif %}>500</option>
                    <option value="1000" {% if user_per_page == 1000 %}selected{% endif %}>1000</option>
                </select>
            </div>
            <div class="pagination-controls-right">
                <nav aria-label="Page navigation" class="pagination-nav">
                    <div class="pagination-controls">
                        <button class="btn-pagination" id="firstPage" aria-label="First page">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="btn-pagination" id="prevPage" aria-label="Previous page">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <div class="page-info" id="currentPageInfo">Loading...</div>
                        <button class="btn-pagination" id="nextPage" aria-label="Next page">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn-pagination" id="lastPage" aria-label="Last page">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </nav>
            </div>
        </div>
        
        
        <!-- Search Modal -->
        <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content modal-content-search">
                <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                <input type="text" class="form-control" id="searchInput" placeholder="Start typing...">
                <div id="searchResults"></div>
                </div>
            </div>
            </div>
        </div>
  
        <!-- The deleteGameModal is now included globally in base.html -->

        <div class="game-library-container" id="gamesContainer">
            {% for game in games %}
            <div class="game-card-container">
                <div class="game-card" onmouseover="showDetails(this, '{{ game.uuid }}')" onmouseout="hideDetails()" data-name="{{ game.name }}" data-size="{{ game.size }}" data-genres="{{ game.genres|join(', ') }}">
                    <button id="menuButton-{{ game.uuid }}" class="button-glass-hamburger"><i class="fas fa-bars"></i></button>
                    <button class="favorite-btn" data-game-uuid="{{ game.uuid }}"
                           data-is-favorite="{{ game.is_favorite|lower }}">
                        <i class="fas fa-heart"></i>
                    </button>

                    {% with game_uuid=game.uuid, game_url=game.url %}
                        {% include 'games/popup_menu.html' %}
                    {% endwith %}

                    {% if show_play_status %}
                    {# Game status button #}
                    {% set status_config = {
                        'unplayed': {'icon': 'fa-box', 'color': '#808080', 'label': 'Unplayed'},
                        'unfinished': {'icon': 'fa-gamepad', 'color': '#4A90E2', 'label': 'Unfinished'},
                        'beaten': {'icon': 'fa-flag-checkered', 'color': '#50C878', 'label': 'Beaten'},
                        'completed': {'icon': 'fa-trophy', 'color': '#FFD700', 'label': 'Completed'},
                        'null': {'icon': 'fa-ban', 'color': '#DC3545', 'label': "Won't Play"}
                    } %}
                    {% set current_status = game.user_status or '' %}
                    {% set status_info = status_config.get(current_status, {'icon': 'fa-circle', 'color': '#808080', 'label': 'No Status'}) %}
                    <button class="game-status-btn" data-game-uuid="{{ game.uuid }}" data-current-status="{{ current_status }}" title="{{ status_info.label }}">
                        <i class="fas {{ status_info.icon }}" style="color: {{ status_info.color }}; {% if not current_status %}opacity: 0.4;{% endif %}"></i>
                    </button>

                    {# Status dropdown menu #}
                    <div class="status-dropdown" data-game-uuid="{{ game.uuid }}" style="display: none;">
                        <div class="status-dropdown-option" data-status="unplayed">
                            <i class="fas fa-box" style="color: #808080;"></i>
                            <span class="status-label">Unplayed</span>
                        </div>
                        <div class="status-dropdown-option" data-status="unfinished">
                            <i class="fas fa-gamepad" style="color: #4A90E2;"></i>
                            <span class="status-label">Unfinished</span>
                        </div>
                        <div class="status-dropdown-option" data-status="beaten">
                            <i class="fas fa-flag-checkered" style="color: #50C878;"></i>
                            <span class="status-label">Beaten</span>
                        </div>
                        <div class="status-dropdown-option" data-status="completed">
                            <i class="fas fa-trophy" style="color: #FFD700;"></i>
                            <span class="status-label">Completed</span>
                        </div>
                        <div class="status-dropdown-option" data-status="null">
                            <i class="fas fa-ban" style="color: #DC3545;"></i>
                            <span class="status-label">Won't Play</span>
                        </div>
                        <div class="status-dropdown-option" data-status="" style="border-top: 1px solid rgba(255, 255, 255, 0.2);">
                            <i class="fas fa-times" style="color: #808080;"></i>
                            <span class="status-label">Clear Status</span>
                        </div>
                    </div>
                    {% endif %}
                    {% if game.cover_url and game.cover_url != 'newstyle/default_cover.jpg' %}
                    <a href="{{ url_for('games.game_details', game_uuid=game.uuid) }}">
                        <img src="{{ url_for('static', filename='library/images/' ~ game.cover_url) }}" alt="{{ game.name }}" class="game-cover">
                    </a>
                    {% else %}
                        <a href="{{ url_for('games.game_details', game_uuid=game.uuid) }}">
                            <img src="{{ url_for('static', filename='newstyle/default_cover.jpg') }}" alt="Default Cover Image" class="game-cover">
                        </a>
                    {% endif %}
                    {% if game.has_local_override %}
                    <div class="local-metadata-badge" title="Uses local metadata or images">L</div>
                    {% endif %}
                    <div id="details-{{ game.uuid }}" class="popup-game-details hidden">
                        <!-- Details and screenshots will be injected here by JavaScript -->
                    </div>
                </div>
            
            </div>
            {% endfor %}
        </div>

        <!-- Bottom Pagination Bar -->
        <div class="pagination-footer">
            <nav aria-label="Page navigation" class="pagination-nav">
                <div class="pagination-controls">
                    <button class="btn-pagination" id="firstPageBottom" aria-label="First page">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="btn-pagination" id="prevPageBottom" aria-label="Previous page">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    <div class="page-info" id="currentPageInfoBottom">Loading...</div>
                    <button class="btn-pagination" id="nextPageBottom" aria-label="Next page">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="btn-pagination" id="lastPageBottom" aria-label="Last page">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </nav>
        </div>

    </div>


    <script>
        var libraryManagerUrl = "{{ url_for('library.libraries') }}";
		var libraryScanUrl = "{{ url_for('main.scan_management', library_uuid=library_uuid) }}";
		var libraryCount = Number("{{ library_count }}");
		var gamesCount = Number("{{ games_count }}");


    </script>

</body>
</html>
{% endblock %}
